{% extends "base.html" %}
{% block title %}单词组列表{% endblock %}

{% block content %}
<h1>单词组列表</h1>

<div class="page-controls" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
    <!-- 排序控制区 -->
    <div class="sort-controls">
        <button id="toggle-drag-mode" class="btn btn-secondary">
            <span class="btn-icon">↕️</span> 开启卡片排序
        </button>
        <div id="drag-instructions" style="display: none; margin-top: 10px;" class="alert alert-info">
            长按卡片可拖动排序。完成后点击"保存排序"按钮。
        </div>
        <div id="drag-buttons" style="display: none; margin-top: 10px;">
            <button id="save-drag-order" class="btn btn-success">保存排序</button>
            <button id="cancel-drag" class="btn btn-secondary">取消</button>
        </div>
    </div>


    <!-- 视图切换控制区 -->
    <div class="view-switch-controls">
        <div class="view-switch-group">
            <span class="view-label">卡片视图：</span>
            <div class="view-options">
                <label class="view-option">
                    <input type="radio" name="card-view" value="default" checked>
                    <span class="view-chip default">默认</span>
                </label>
                <label class="view-option">
                    <input type="radio" name="card-view" value="compact">
                    <span class="view-chip compact">紧凑</span>
                </label>
            </div>
        </div>
    </div>
    
    <!-- 新增筛选控制区 -->
    <div class="filter-controls">
        <div class="filter-btn-group">
            <span class="filter-label">筛选：</span>
            <label class="filter-btn">
                <input type="checkbox" data-filter="diamond" checked>
                <span class="chip diamond">钻石</span>
            </label>
            <label class="filter-btn">
                <input type="checkbox" data-filter="gold" checked>
                <span class="chip gold">黄金</span>
            </label>
            <label class="filter-btn">
                <input type="checkbox" data-filter="bronze" checked>
                <span class="chip bronze">青铜</span>
            </label>
            <label class="filter-btn">
                <input type="checkbox" data-filter="basic" checked>
                <span class="chip basic">基础</span>
            </label>
        </div>
    </div>
</div>

<div class="group-list" id="sortable-groups">
    {% for group in groups %}
    <div class="group-card 
        {% if group.stats.random_last_score == 1.0 %}diamond-card
        {% elif group.stats.last_score == 1.0 %}gold-card
        {% elif group.stats.study_count >= 3 %}bronze-card
        {% else %}basic-card
        {% endif %}"
        data-id="{{ group.id }}"
        data-type="{% if group.stats.random_last_score == 1.0 %}diamond{% elif group.stats.last_score == 1.0 %}gold{% elif group.stats.study_count >= 3 %}bronze{% else %}basic{% endif %}"
        data-order="{{ group.order_index or loop.index }}">
        
        <!-- 添加卡片内部容器用于翻转效果 -->
        <div class="card-inner">
            <!-- 卡片正面 -->
            <div class="card-front">
                <h2>{{ group.name }}</h2>
                <p>单词数量：{{ group.words.count() }}</p>
                <div class="stats">
                    <span>背诵次数：{{ group.stats.study_count }}</span>
                    <span>顺序测试正确率：{{ "%.1f"|format(group.stats.last_score*100) }}%</span>
                    <span>乱序测试正确率：{{ "%.1f"|format((group.stats.random_last_score or 0)*100) }}%</span>
                </div>
                <div class="actions">
                    <a href="{{ url_for('practice.study_mode', group_id=group.id) }}" class="btn glass-btn study">背诵模式</a>
                    <a href="{{ url_for('practice.quiz_mode', group_id=group.id, mode='order') }}" class="btn glass-btn order">顺序测试</a>
                    <a href="{{ url_for('practice.quiz_mode', group_id=group.id, mode='random') }}" class="btn glass-btn random">乱序测试</a>
                </div>
                
                {% if group.stats.random_last_score == 1.0 %}
                <div class="card-badge diamond">钻石</div>
                {% elif group.stats.last_score == 1.0 %}
                <div class="card-badge gold">黄金</div>
                {% elif group.stats.study_count >= 3 %}
                <div class="card-badge bronze">青铜</div>
                {% endif %}
            </div>
            
            <!-- 卡片背面 (小卡片翻转后显示) -->
            <div class="card-back">
                <a href="{{ url_for('practice.study_mode', group_id=group.id) }}" class="back-btn study">背诵</a>
                <a href="{{ url_for('practice.quiz_mode', group_id=group.id, mode='order') }}" class="back-btn order">顺序</a>
                <a href="{{ url_for('practice.quiz_mode', group_id=group.id, mode='random') }}" class="back-btn random">乱序</a>
            </div>
        </div>
        
        <!-- 添加拖动手柄，默认隐藏 -->

    </div>
    {% endfor %}
</div>

<!-- 添加拖放相关JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleDragBtn = document.getElementById('toggle-drag-mode');
    const instructionsPanel = document.getElementById('drag-instructions');
    const dragButtons = document.getElementById('drag-buttons');
    const saveDragOrderBtn = document.getElementById('save-drag-order');
    const cancelDragBtn = document.getElementById('cancel-drag');
    const groupList = document.getElementById('sortable-groups');
    const cards = groupList.querySelectorAll('.group-card');
    const dragHandles = document.querySelectorAll('.drag-handle');
    
    let dragMode = false;
    let originalOrder = [];
    
    // 保存原始顺序
    function saveOriginalOrder() {
        originalOrder = [];
        cards.forEach(card => {
            originalOrder.push({
                id: card.dataset.id,
                element: card
            });
        });
    }
    
    // 恢复原始顺序
    function restoreOriginalOrder() {
        originalOrder.forEach(item => {
            groupList.appendChild(item.element);
        });
    }
    
    // 切换拖放模式
    toggleDragBtn.addEventListener('click', function() {
        dragMode = !dragMode;
        
        if (dragMode) {
            // 保存原始顺序
            saveOriginalOrder();
            
            // 启用拖放
            cards.forEach(card => {
                card.setAttribute('draggable', 'true');
                card.classList.add('draggable');
            });
            
            // 显示拖动手柄
            dragHandles.forEach(handle => {
                handle.style.display = 'flex';
            });
            
            // 更新UI
            toggleDragBtn.textContent = '关闭卡片排序';
            toggleDragBtn.classList.add('btn-warning');
            toggleDragBtn.classList.remove('btn-secondary');
            instructionsPanel.style.display = 'block';
            dragButtons.style.display = 'block';
            
            // 禁用卡片内的按钮链接
            groupList.querySelectorAll('.actions a').forEach(link => {
                link.addEventListener('click', preventClickDuringDrag);
                link.classList.add('disabled-during-drag');
            });
        } else {
            // 关闭拖放模式
            disableDragMode();
        }
    });
    
    // 关闭拖放模式
    function disableDragMode() {
        // 禁用拖放
        cards.forEach(card => {
            card.removeAttribute('draggable');
            card.classList.remove('draggable');
        });
        
        // 隐藏拖动手柄
        dragHandles.forEach(handle => {
            handle.style.display = 'none';
        });
        
        // 更新UI
        toggleDragBtn.textContent = '开启卡片排序';
        toggleDragBtn.classList.remove('btn-warning');
        toggleDragBtn.classList.add('btn-secondary');
        instructionsPanel.style.display = 'none';
        dragButtons.style.display = 'none';
        
        // 重新启用卡片内的按钮链接
        groupList.querySelectorAll('.actions a').forEach(link => {
            link.removeEventListener('click', preventClickDuringDrag);
            link.classList.remove('disabled-during-drag');
        });
        
        dragMode = false;
    }
    
    // 阻止拖放模式下的点击
    function preventClickDuringDrag(e) {
        if (dragMode) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    }
    
    // 取消拖放排序
    cancelDragBtn.addEventListener('click', function() {
        restoreOriginalOrder();
        disableDragMode();
    });
    
    // 保存拖放排序
    saveDragOrderBtn.addEventListener('click', function() {
        const newOrder = [];
        const currentCards = groupList.querySelectorAll('.group-card');
        
        currentCards.forEach((card, index) => {
            newOrder.push({
                id: parseInt(card.dataset.id),
                order: index + 1
            });
    });


    // 使用表单提交到后端保存
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("groups.update_order") }}';
    
    // 添加排序数据
    const orderInput = document.createElement('input');
    orderInput.type = 'hidden';
    orderInput.name = 'order_data';
    orderInput.value = JSON.stringify({ groups: newOrder });
    
    // 添加来源页面信息
    const refererInput = document.createElement('input');
    refererInput.type = 'hidden';
    refererInput.name = 'referer';
    refererInput.value = 'main';
    
    form.appendChild(orderInput);
    form.appendChild(refererInput);
    document.body.appendChild(form);
    form.submit();
        });
    
    // 拖放事件处理
    let draggedItem = null;
    
    cards.forEach(card => {
        // 长按触发拖动（移动设备支持）
        let longPressTimer;
        
        card.addEventListener('touchstart', function(e) {
            if (!dragMode) return;
            
            longPressTimer = setTimeout(() => {
                this.classList.add('dragging');
                draggedItem = this;
            }, 500); // 长按500ms激活
        });
        
        card.addEventListener('touchend', function() {
            if (longPressTimer) clearTimeout(longPressTimer);
            this.classList.remove('dragging');
        });
        
        // 更新触摸拖放事件
        card.addEventListener('touchmove', function(e) {
            if (!dragMode || !draggedItem) return;
            
            e.preventDefault(); // 防止页面滚动
            
            const touch = e.touches[0];
            const pageX = touch.pageX;
            const pageY = touch.pageY;
            
            const afterElement = getDragAfterElement(groupList, pageX, pageY);
            if (afterElement == null) {
                groupList.appendChild(draggedItem);
            } else {
                groupList.insertBefore(draggedItem, afterElement);
            }
        });
        
        // 电脑拖放支持
        card.addEventListener('dragstart', function() {
            if (!dragMode) return;
            
            this.classList.add('dragging');
            draggedItem = this;
        });
        
        card.addEventListener('dragend', function() {
            this.classList.remove('dragging');
        });
    });
    
    // 更新鼠标拖放事件
    groupList.addEventListener('dragover', function(e) {
        if (!dragMode) return;
        
        e.preventDefault();
        const afterElement = getDragAfterElement(groupList, e.clientX, e.clientY);
        const draggable = document.querySelector('.dragging');
        
        if (afterElement == null) {
            groupList.appendChild(draggable);
        } else {
            groupList.insertBefore(draggable, afterElement);
        }
    });
    
    // 确定拖动后的位置- 改进版本，适应不同视图模式
 
    function getDragAfterElement(container, x, y) {
        const isCompactView = document.querySelector('.container').classList.contains('compact-view');
        const draggableElements = [...container.querySelectorAll('.group-card:not(.dragging)')];
        
        if (isCompactView) {
            // 紧凑视图下：考虑卡片的二维网格布局
            // 计算哪张卡片与拖动位置最近，考虑 X 和 Y 坐标
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                
                // 计算拖动点到卡片中心的距离
                const centerX = box.left + box.width / 2;
                const centerY = box.top + box.height / 2;
                const distanceSquared = Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2);
                
                // 我们只关心拖动点上方和左侧的卡片
                const isBefore = (y < box.top + box.height / 2) || 
                                (y < box.top + box.height + 20 && x < box.left);
                
                if (isBefore && (!closest.element || distanceSquared < closest.distance)) {
                    return { distance: distanceSquared, element: child };
                } else {
                    return closest;
                }
            }, { distance: Infinity }).element;
        } else {
            // 默认视图下：主要考虑垂直位置
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
    }






});


// 添加筛选功能
document.addEventListener('DOMContentLoaded', function() {
    const filterCheckboxes = document.querySelectorAll('.filter-btn input[type="checkbox"]');
    const cards = document.querySelectorAll('.group-card');
    
    // 从localStorage加载筛选状态
    let activeFilters = loadFiltersFromStorage() || {
        diamond: true,
        gold: true,
        bronze: true,
        basic: true
    };
    
    // 初始化复选框状态
    filterCheckboxes.forEach(checkbox => {
        const filterType = checkbox.dataset.filter;
        checkbox.checked = activeFilters[filterType];
    });
    
    // 初始应用筛选
    applyFilters();
    
    // 保存筛选状态到localStorage
    function saveFiltersToStorage() {
        localStorage.setItem('wordweb_filters', JSON.stringify(activeFilters));
    }
    
    // 从localStorage加载筛选状态
    function loadFiltersFromStorage() {
        const savedFilters = localStorage.getItem('wordweb_filters');
        return savedFilters ? JSON.parse(savedFilters) : null;
    }
    
    // 应用筛选 - 修复的逻辑
    function applyFilters() {
        cards.forEach(card => {
            // 获取卡片类型并清理可能的空白字符
            const cardType = card.dataset.type.trim();
            
            if (activeFilters[cardType]) {
                card.classList.remove('hidden-card');
            } else {
                card.classList.add('hidden-card');
            }
        });
        
        // 调试输出当前筛选状态
        console.log('应用筛选:', activeFilters);
        console.log('卡片类型:', Array.from(cards).map(c => c.dataset.type.trim()));
    }
    
    // 监听筛选复选框变化
    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const filterType = this.dataset.filter;
            activeFilters[filterType] = this.checked;
            
            // 应用并保存筛选设置
            applyFilters();
            saveFiltersToStorage();
        });
    });
});


// 视图切换功能
document.addEventListener('DOMContentLoaded', function() {
    const viewOptions = document.querySelectorAll('input[name="card-view"]');
    const container = document.querySelector('.container');
    
    // 从localStorage加载已保存的视图设置
    const savedView = localStorage.getItem('wordweb_card_view');
    if (savedView) {
        // 设置已保存的视图
        viewOptions.forEach(option => {
            if (option.value === savedView) {
                option.checked = true;
                applyCardView(savedView);
            }
        });
    }
    
    // 监听视图选择变化
    viewOptions.forEach(option => {
        option.addEventListener('change', function() {
            if (this.checked) {
                const viewType = this.value;
                applyCardView(viewType);
                
                // 保存设置到localStorage
                localStorage.setItem('wordweb_card_view', viewType);
            }
        });
    });
    
    // 应用卡片视图类型

    function applyCardView(viewType) {
        if (viewType === 'compact') {
            container.classList.add('compact-view');
            
            // 确保在紧凑视图下大卡片正面的内容清晰可见
            document.querySelectorAll('.card-front').forEach(front => {
                if (front.querySelector('h2')) {
                    front.style.position = 'absolute';
                }
            });
            
            // 确保小卡片背面按钮可点击
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.style.display = 'block';
            });
        } else {
            container.classList.remove('compact-view');
            
            // 恢复默认视图下的样式
            document.querySelectorAll('.card-front').forEach(front => {
                front.style.position = '';
            });
            
            // 隐藏小卡片背面按钮
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.style.display = 'none';
            });
        }
    }


});

</script>
{% endblock %}