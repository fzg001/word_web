{% extends "base.html" %}
{% block title %}æ–°å»ºå•è¯ç»„{% endblock %}

{% block content %}
<h1>æ–°å»ºå•è¯ç»„</h1>

{% if success_message %}
<div class="alert alert-success">{{ success_message }}</div>
{% endif %}

{% if error_lines %}
<div class="alert alert-warning">
    <p>ä»¥ä¸‹è¡Œæ— æ³•è¢«è§£æä¸ºæœ‰æ•ˆå•è¯ï¼š</p>
    <ul>
        {% for line in error_lines %}
        <li>{{ line }}</li>
        {% endfor %}
    </ul>
    <p>æ­£ç¡®æ ¼å¼ç¤ºä¾‹: "English - ä¸­æ–‡" æˆ– "Englishâ€”ä¸­æ–‡"</p>
</div>
{% endif %}

<div class="form-container">
    <form method="POST" class="styled-form">
        <div class="form-group">
            <label for="group_name">ç»„åˆ«åç§°</label>
            <div class="input-with-button">
                <input type="text" id="group_name" name="group_name" required
                    class="form-control" placeholder="ä¾‹å¦‚ï¼šç”Ÿç‰©å­¦åŸºç¡€è¯æ±‡"
                    value="{{ group_name or '' }}">
                <button type="button" id="ai-generate-btn" class="btn btn-secondary">
                    <span class="btn-icon">ğŸ¤–</span> AIç”Ÿæˆ
                </button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="words">å•è¯åˆ—è¡¨</label>
            <p class="form-hint">æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šè‹±æ–‡ - ä¸­æ–‡<br>
               <strong>æ”¯æŒå¸¦åºå·å’Œæ ¼å¼æ ‡è®°çš„è¾“å…¥</strong>ï¼Œå¦‚: "1. <strong>Word</strong> - å•è¯"</p>
            <textarea id="words" name="words" rows="15" required
                    class="form-control" placeholder="ç¤ºä¾‹ï¼š
Enzyme - é…¶
Protein - è›‹ç™½è´¨
...">{{ words_text or '' }}</textarea>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">åˆ›å»ºç»„åˆ«</button>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<!-- æ·»åŠ åŠ è½½æ•ˆæœæ ·å¼ -->
<style>
.input-with-button {
    position: relative;
    display: flex;
    gap: 10px;
    align-items: center;
}

.input-with-button .form-control {
    flex: 1;
}

.ai-loading {
    position: relative;
}

.ai-loading:after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" r="32" stroke-width="8" stroke="%234285f4" stroke-dasharray="50.26548245743669 50.26548245743669" fill="none" stroke-linecap="round" transform="rotate(217.609 50 50)"><animateTransform attributeName="transform" type="rotate" dur="1s" repeatCount="indefinite" keyTimes="0;1" values="0 50 50;360 50 50"></animateTransform></circle></svg>') center center no-repeat;
    background-size: 50px;
    z-index: 10;
    border-radius: 8px;
}
</style>

<!-- æ·»åŠ  AI ç”ŸæˆåŠŸèƒ½çš„ JavaScript -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM å·²åŠ è½½ï¼Œå‡†å¤‡è®¾ç½®äº‹ä»¶ç›‘å¬å™¨");
    
    const aiGenerateBtn = document.getElementById('ai-generate-btn');
    const groupNameInput = document.getElementById('group_name');
    const wordsTextarea = document.getElementById('words');
    
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦æˆåŠŸè·å–
    if (!aiGenerateBtn) console.error("æ— æ³•æ‰¾åˆ° AI ç”ŸæˆæŒ‰é’®!");
    if (!groupNameInput) console.error("æ— æ³•æ‰¾åˆ°ç»„åˆ«åç§°è¾“å…¥æ¡†!");
    if (!wordsTextarea) console.error("æ— æ³•æ‰¾åˆ°å•è¯åˆ—è¡¨æ–‡æœ¬æ¡†!");
    
    console.log("ä¸º AI ç”ŸæˆæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨");
    
    aiGenerateBtn.addEventListener('click', async function() {
        console.log("AI ç”ŸæˆæŒ‰é’®è¢«ç‚¹å‡»");
        const groupName = groupNameInput.value.trim();
        
        if (!groupName) {
            alert('è¯·å…ˆè¾“å…¥ç»„åˆ«åç§°ï¼Œä¾‹å¦‚ï¼šç”Ÿç‰©åŒ–å­¦é¢†åŸŸå¸¸ç”¨50è¯');
            groupNameInput.focus();
            return;
        }
        
        console.log("å‡†å¤‡å‘é€è¯·æ±‚ï¼Œä¸»é¢˜:", groupName);
        
        // æ·»åŠ åŠ è½½æ•ˆæœ
        wordsTextarea.classList.add('ai-loading');
        aiGenerateBtn.disabled = true;
        aiGenerateBtn.innerHTML = '<span class="btn-icon">â³</span> ç”Ÿæˆä¸­...';
        
        try {
            console.log("å¼€å§‹å‘é€è¯·æ±‚åˆ°:", '{{ url_for("settings.generate_ai_words") }}');
            
            const response = await fetch('{{ url_for("settings.generate_ai_words") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ topic: groupName })
            });
            
            console.log("æ”¶åˆ°å“åº”:", response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("é”™è¯¯å“åº”å†…å®¹:", errorText);
                try {
                    const errorJson = JSON.parse(errorText);
                    throw new Error(errorJson.error || `æœåŠ¡å™¨é”™è¯¯(${response.status})`);
                } catch (e) {
                    throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status} - ${errorText.substring(0, 100)}`);
                }
            }
            
            const data = await response.json();
            console.log("è§£æå“åº”:", data);
            
            if (data.success) {
                wordsTextarea.value = data.words;
                console.log("æˆåŠŸè®¾ç½®å•è¯æ–‡æœ¬");
            } else {
                console.error("ç”Ÿæˆå¤±è´¥:", data.error);
                alert('ç”Ÿæˆå¤±è´¥: ' + data.error);
            }
        } catch (error) {
            console.error('AIç”Ÿæˆé”™è¯¯:', error);
            alert('ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š' + error.message);
        } finally {
            // ç§»é™¤åŠ è½½æ•ˆæœ
            wordsTextarea.classList.remove('ai-loading');
            aiGenerateBtn.disabled = false;
            aiGenerateBtn.innerHTML = '<span class="btn-icon">ğŸ¤–</span> AIç”Ÿæˆ';
            console.log("è¯·æ±‚å¤„ç†å®Œæˆ");
        }
    });
    
    console.log("äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ");
});
</script>

</script>
{% endblock %}